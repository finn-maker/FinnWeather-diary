"use strict";(self.webpackChunkweather_diary_react=self.webpackChunkweather_diary_react||[]).push([[502],{4502:(e,s,r)=>{r.r(s),r.d(s,{default:()=>se});var t=r(5043),o=r(2110),a=r(6494),i=r(6446),n=r(5865),l=r(3845),c=r(611),d=r(7392),u=r(547),m=r(8911),A=r(1906),h=r(35),y=r(6600),_=r(5316),g=r(4493),S=r(4605),E=r(7843),p=r(9347),w=r(1827),x=r(3005),j=r(6479),v=r(7365),T=r(4319),b=r(5613),f=r(516),C=r(1885),I=r(5472),O=r(9365),R=r(7064);const D={apiKey:{NODE_ENV:"production",PUBLIC_URL:"/skills-communicate-using-markdown",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_FIREBASE_API_KEY||"your-api-key",authDomain:{NODE_ENV:"production",PUBLIC_URL:"/skills-communicate-using-markdown",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_FIREBASE_AUTH_DOMAIN||"your-project.firebaseapp.com",projectId:{NODE_ENV:"production",PUBLIC_URL:"/skills-communicate-using-markdown",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_FIREBASE_PROJECT_ID||"your-project-id",storageBucket:{NODE_ENV:"production",PUBLIC_URL:"/skills-communicate-using-markdown",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_FIREBASE_STORAGE_BUCKET||"your-project.appspot.com",messagingSenderId:{NODE_ENV:"production",PUBLIC_URL:"/skills-communicate-using-markdown",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_FIREBASE_MESSAGING_SENDER_ID||"123456789",appId:{NODE_ENV:"production",PUBLIC_URL:"/skills-communicate-using-markdown",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_FIREBASE_APP_ID||"your-app-id"},P=(0,R.Wp)(D),k=(0,I.aU)(P),F=(0,O.xI)(P),z=()=>"your-api-key"!==D.apiKey&&"your-project-id"!==D.projectId;let K=null;const W=()=>new Promise((e,s)=>{z()?(0,O.hg)(F,async r=>{if(r)K=r.uid,localStorage.setItem("weather_diary_user_id",r.uid),e(r.uid);else try{const s=await(0,O.zK)(F);K=s.user.uid,localStorage.setItem("weather_diary_user_id",s.user.uid),e(s.user.uid)}catch(t){console.error("\u533f\u540d\u767b\u5f55\u5931\u8d25:",t),s(t)}}):s(new Error("Firebase\u672a\u914d\u7f6e"))}),B=()=>{if(K)return K;const e=localStorage.getItem("weather_diary_user_id");if(e)return K=e,e;throw new Error("\u7528\u6237\u672a\u767b\u5f55")},H=async e=>{try{if(!z())throw new Error("Firebase\u672a\u914d\u7f6e\uff0c\u4f7f\u7528\u672c\u5730\u5b58\u50a8");const s=B(),r={...e,userId:s,timestamp:Date.now(),createdAt:I.Dc.now(),updatedAt:I.Dc.now()},t=await(0,I.gS)((0,I.rJ)(k,"diaries"),r),o={...e,id:t.id,timestamp:r.timestamp};return console.log("\u65e5\u8bb0\u5df2\u4fdd\u5b58\u5230\u4e91\u7aef:",t.id),o}catch(s){throw console.error("\u4fdd\u5b58\u5230\u4e91\u7aef\u5931\u8d25:",s),s}},U=async()=>{try{if(!z())throw new Error("Firebase\u672a\u914d\u7f6e");const s=JSON.parse(localStorage.getItem("weather_diary_entries")||"[]"),r=await(async()=>{try{if(!z())throw new Error("Firebase\u672a\u914d\u7f6e");const e=B(),s=(0,I.P)((0,I.rJ)(k,"diaries"),(0,I._M)("userId","==",e),(0,I.My)("timestamp","desc"),(0,I.AB)(100)),r=await(0,I.GG)(s),t=[];return r.forEach(e=>{const s=e.data();t.push({id:e.id,title:s.title,content:s.content,mood:s.mood,weather:s.weather,timestamp:s.timestamp})}),console.log(`\u4ece\u4e91\u7aef\u83b7\u53d6\u5230 ${t.length} \u6761\u65e5\u8bb0`),t}catch(e){throw console.error("\u4ece\u4e91\u7aef\u83b7\u53d6\u65e5\u8bb0\u5931\u8d25:",e),e}})(),t=new Set(r.map(e=>e.id));let o=0,a=0;for(const i of s)if(!t.has(i.id))try{await H({title:i.title,content:i.content,mood:i.mood,weather:i.weather}),o++}catch(e){console.error("\u540c\u6b65\u5931\u8d25:",e),a++}return console.log(`\u540c\u6b65\u5b8c\u6210: \u6210\u529f ${o} \u6761, \u5931\u8d25 ${a} \u6761`),{success:o,failed:a}}catch(e){throw console.error("\u540c\u6b65\u672c\u5730\u5230\u4e91\u7aef\u5931\u8d25:",e),e}},L=async()=>{try{return!!z()&&(await(0,I.GG)((0,I.P)((0,I.rJ)(k,"diaries"),(0,I.AB)(1))),!0)}catch(e){return console.error("\u4e91\u7aef\u8fde\u63a5\u68c0\u67e5\u5931\u8d25:",e),!1}};let N={mode:"local",cloudAvailable:!1,lastSync:null,syncing:!1},$=null;const G=async()=>{try{if(!z())return console.log("\ud83d\udcf1 Firebase\u672a\u914d\u7f6e\uff0c\u4f7f\u7528\u672c\u5730\u5b58\u50a8\u6a21\u5f0f"),N.mode="local",N;if(!await L())return console.log("\ud83d\udd0c \u4e91\u7aef\u8fde\u63a5\u5931\u8d25\uff0c\u4f7f\u7528\u672c\u5730\u5b58\u50a8\u6a21\u5f0f"),N.mode="local",N;try{return await W(),N.cloudAvailable=!0,N.mode="hybrid",console.log("\u2601\ufe0f \u4e91\u7aef\u5b58\u50a8\u5df2\u542f\u7528\uff0c\u4f7f\u7528\u6df7\u5408\u6a21\u5f0f"),await M(),N}catch(e){return console.error("\u8ba4\u8bc1\u5931\u8d25\uff0c\u964d\u7ea7\u5230\u672c\u5730\u6a21\u5f0f:",e),N.mode="local",N}}catch(s){return console.error("\u521d\u59cb\u5316\u5b58\u50a8\u5931\u8d25:",s),N.mode="local",N}},M=async()=>{if(!N.syncing)try{N.syncing=!0,console.log("\ud83d\udd04 \u5f00\u59cb\u521d\u59cb\u540c\u6b65...");const e=await U();N.lastSync=Date.now(),console.log(`\u2705 \u540c\u6b65\u5b8c\u6210: \u6210\u529f ${e.success} \u6761, \u5931\u8d25 ${e.failed} \u6761`)}catch(e){console.error("\u521d\u59cb\u540c\u6b65\u5931\u8d25:",e)}finally{N.syncing=!1}},J=async()=>{if(!N.cloudAvailable)throw new Error("\u4e91\u7aef\u5b58\u50a8\u4e0d\u53ef\u7528");if(N.syncing)throw new Error("\u6b63\u5728\u540c\u6b65\u4e2d\uff0c\u8bf7\u7a0d\u5019");try{N.syncing=!0;const e=await U();return N.lastSync=Date.now(),e}finally{N.syncing=!1}},V=()=>({...N}),Y=async e=>{if("cloud"===e&&!N.cloudAvailable)throw new Error("\u4e91\u7aef\u5b58\u50a8\u4e0d\u53ef\u7528");N.mode=e,console.log(`\ud83d\udcdd \u5b58\u50a8\u6a21\u5f0f\u5df2\u5207\u6362\u5230: ${e}`),"hybrid"===e&&N.cloudAvailable?Q():q()},Q=()=>{$&&q();try{$=(e=>{try{if(!z())throw new Error("Firebase\u672a\u914d\u7f6e");const s=B(),r=(0,I.P)((0,I.rJ)(k,"diaries"),(0,I._M)("userId","==",s),(0,I.My)("timestamp","desc"),(0,I.AB)(100));return(0,I.aQ)(r,s=>{const r=[];s.forEach(e=>{const s=e.data();r.push({id:e.id,title:s.title,content:s.content,mood:s.mood,weather:s.weather,timestamp:s.timestamp})}),console.log(`\u5b9e\u65f6\u66f4\u65b0\uff1a\u83b7\u53d6\u5230 ${r.length} \u6761\u65e5\u8bb0`),e(r)},e=>{console.error("\u5b9e\u65f6\u76d1\u542c\u5931\u8d25:",e)})}catch(s){return console.error("\u8ba2\u9605\u4e91\u7aef\u6570\u636e\u5931\u8d25:",s),()=>{}}})(e=>{console.log("\ud83d\udd04 \u4e91\u7aef\u6570\u636e\u5df2\u66f4\u65b0\uff0c\u89e6\u53d1UI\u5237\u65b0"),window.dispatchEvent(new CustomEvent("cloudDataUpdated",{detail:{entries:e}}))}),console.log("\ud83d\udc40 \u4e91\u7aef\u6570\u636e\u76d1\u542c\u5df2\u542f\u52a8")}catch(e){console.error("\u542f\u52a8\u4e91\u7aef\u76d1\u542c\u5931\u8d25:",e)}},q=()=>{$&&($(),$=null,console.log("\ud83d\udc40 \u4e91\u7aef\u6570\u636e\u76d1\u542c\u5df2\u505c\u6b62"))},X=async()=>{try{console.log("\ud83d\udd04 \u91cd\u65b0\u521d\u59cb\u5316\u4e91\u7aef\u8fde\u63a5...");return await L()?(await W(),N.cloudAvailable=!0,N.mode="hybrid",console.log("\u2705 \u4e91\u7aef\u8fde\u63a5\u5df2\u6062\u590d"),!0):(console.log("\u274c \u4e91\u7aef\u8fde\u63a5\u5931\u8d25"),!1)}catch(e){return console.error("\u91cd\u65b0\u521d\u59cb\u5316\u5931\u8d25:",e),!1}},Z={LOCAL:"local",CLOUD:"cloud",HYBRID:"hybrid"};var ee=r(579);const se=e=>{let{onStorageChange:s}=e;const[r,I]=(0,t.useState)(V()),[O,R]=(0,t.useState)(!1),[D,P]=(0,t.useState)(!1),[k,F]=(0,t.useState)(null),[K,W]=(0,t.useState)(!0),B=()=>{I(V())},H=async e=>{try{await Y(e),B(),F({type:"success",message:`\u5df2\u5207\u6362\u5230${U(e)}\u6a21\u5f0f`}),s&&s()}catch(r){F({type:"error",message:"\u5207\u6362\u6a21\u5f0f\u5931\u8d25: "+r.message})}},U=e=>{switch(e){case"local":return"\u672c\u5730\u5b58\u50a8";case"cloud":return"\u4e91\u7aef\u5b58\u50a8";case"hybrid":return"\u6df7\u5408\u5b58\u50a8";default:return"\u672a\u77e5"}};return(0,t.useEffect)(()=>{const e=setInterval(B,3e4);return()=>clearInterval(e)},[]),(0,t.useEffect)(()=>{if(k){const e=setTimeout(()=>F(null),5e3);return()=>clearTimeout(e)}},[k]),(0,ee.jsxs)(o.A,{elevation:2,sx:{mb:2},children:[(0,ee.jsxs)(a.A,{children:[(0,ee.jsxs)(i.A,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,children:[(0,ee.jsxs)(i.A,{display:"flex",alignItems:"center",gap:1,children:[r.cloudAvailable&&"hybrid"===r.mode?(0,ee.jsx)(w.A,{size:20}):"local"===r.mode?(0,ee.jsx)(x.A,{size:20}):(0,ee.jsx)(j.A,{size:20}),(0,ee.jsx)(n.A,{variant:"h6",fontWeight:"bold",children:"\u4e91\u7aef\u5b58\u50a8"}),(0,ee.jsx)(l.A,{label:U(r.mode),color:r.cloudAvailable&&"hybrid"===r.mode?"success":"local"===r.mode?"warning":"error",size:"small"})]}),(0,ee.jsxs)(i.A,{display:"flex",alignItems:"center",gap:1,children:[r.syncing&&(0,ee.jsx)(c.A,{sx:{width:100}}),(0,ee.jsx)(d.A,{size:"small",onClick:()=>P(!0),children:(0,ee.jsx)(v.A,{size:16})})]})]}),(0,ee.jsx)(i.A,{mb:2,children:(0,ee.jsx)(u.A,{severity:z()?"info":"warning",sx:{fontSize:"0.875rem"},children:z()?(0,ee.jsxs)(i.A,{display:"flex",alignItems:"center",gap:1,children:[(0,ee.jsx)(T.A,{size:16}),"Firebase\u5df2\u914d\u7f6e\uff0c\u652f\u6301\u4e91\u7aef\u5b58\u50a8"]}):(0,ee.jsxs)(i.A,{display:"flex",alignItems:"center",gap:1,children:[(0,ee.jsx)(b.A,{size:16}),"Firebase\u672a\u914d\u7f6e\uff0c\u4ec5\u652f\u6301\u672c\u5730\u5b58\u50a8"]})})}),(0,ee.jsxs)(m.A,{direction:"row",spacing:1,flexWrap:"wrap",useFlexGap:!0,children:[!z()&&(0,ee.jsx)(u.A,{severity:"info",sx:{width:"100%",fontSize:"0.8rem"},children:"\u8981\u542f\u7528\u4e91\u7aef\u5b58\u50a8\uff0c\u8bf7\u914d\u7f6eFirebase\u3002\u67e5\u770bREADME\u6587\u6863\u4e86\u89e3\u8be6\u7ec6\u6b65\u9aa4\u3002"}),z()&&!r.cloudAvailable&&(0,ee.jsx)(A.A,{variant:"contained",startIcon:(0,ee.jsx)(w.A,{size:16}),onClick:async()=>{R(!0);try{await G(),B(),F({type:"success",message:"\u4e91\u7aef\u5b58\u50a8\u5df2\u521d\u59cb\u5316"}),s&&s()}catch(e){F({type:"error",message:"\u521d\u59cb\u5316\u5931\u8d25: "+e.message})}finally{R(!1)}},disabled:O,size:"small",children:"\u542f\u7528\u4e91\u7aef\u5b58\u50a8"}),r.cloudAvailable&&(0,ee.jsxs)(ee.Fragment,{children:[(0,ee.jsx)(A.A,{variant:"outlined",startIcon:(0,ee.jsx)(f.A,{size:16}),onClick:async()=>{R(!0);try{const e=await J();F({type:"success",message:`\u540c\u6b65\u5b8c\u6210: \u6210\u529f ${e.success} \u6761, \u5931\u8d25 ${e.failed} \u6761`}),B(),s&&s()}catch(e){F({type:"error",message:"\u540c\u6b65\u5931\u8d25: "+e.message})}finally{R(!1)}},disabled:O,size:"small",children:"\u624b\u52a8\u540c\u6b65"}),"local"===r.mode&&(0,ee.jsx)(A.A,{variant:"contained",startIcon:(0,ee.jsx)(w.A,{size:16}),onClick:()=>H(Z.HYBRID),size:"small",children:"\u5207\u6362\u5230\u6df7\u5408\u6a21\u5f0f"})]}),!r.cloudAvailable&&z()&&(0,ee.jsx)(A.A,{variant:"outlined",startIcon:(0,ee.jsx)(C.A,{size:16}),onClick:async()=>{R(!0);try{await X()?(B(),F({type:"success",message:"\u4e91\u7aef\u8fde\u63a5\u5df2\u6062\u590d"}),s&&s()):F({type:"error",message:"\u4e91\u7aef\u8fde\u63a5\u5931\u8d25"})}catch(e){F({type:"error",message:"\u91cd\u8fde\u5931\u8d25: "+e.message})}finally{R(!1)}},disabled:O,size:"small",children:"\u91cd\u65b0\u8fde\u63a5"})]}),r.lastSync&&(0,ee.jsxs)(n.A,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:["\u4e0a\u6b21\u540c\u6b65: ",new Date(r.lastSync).toLocaleString()]}),k&&(0,ee.jsx)(u.A,{severity:k.type,sx:{mt:2},onClose:()=>F(null),children:k.message})]}),(0,ee.jsxs)(h.A,{open:D,onClose:()=>P(!1),maxWidth:"sm",fullWidth:!0,children:[(0,ee.jsx)(y.A,{children:"\u4e91\u7aef\u5b58\u50a8\u914d\u7f6e"}),(0,ee.jsx)(_.A,{children:(0,ee.jsxs)(m.A,{spacing:3,sx:{pt:1},children:[(0,ee.jsxs)(i.A,{children:[(0,ee.jsx)(n.A,{variant:"subtitle2",gutterBottom:!0,children:"\u5b58\u50a8\u6a21\u5f0f"}),(0,ee.jsx)(m.A,{direction:"row",spacing:1,children:Object.values(Z).map(e=>(0,ee.jsx)(A.A,{variant:r.mode===e?"contained":"outlined",onClick:()=>H(e),disabled:"cloud"===e&&!r.cloudAvailable,size:"small",children:U(e)},e))})]}),(0,ee.jsx)(g.A,{}),(0,ee.jsx)(S.A,{control:(0,ee.jsx)(E.A,{checked:K,onChange:e=>W(e.target.checked)}),label:"\u81ea\u52a8\u540c\u6b65 (\u6bcf5\u5206\u949f)"}),(0,ee.jsxs)(i.A,{children:[(0,ee.jsx)(n.A,{variant:"subtitle2",gutterBottom:!0,children:"\u5b58\u50a8\u72b6\u6001"}),(0,ee.jsxs)(i.A,{display:"flex",alignItems:"center",gap:1,mb:1,children:[(0,ee.jsx)(n.A,{variant:"body2",children:"\u6a21\u5f0f:"}),(0,ee.jsx)(l.A,{label:U(r.mode),size:"small"})]}),(0,ee.jsxs)(i.A,{display:"flex",alignItems:"center",gap:1,mb:1,children:[(0,ee.jsx)(n.A,{variant:"body2",children:"\u4e91\u7aef\u53ef\u7528:"}),r.cloudAvailable?(0,ee.jsx)(T.A,{size:16,color:"green"}):(0,ee.jsx)(j.A,{size:16,color:"gray"})]}),r.syncing&&(0,ee.jsxs)(i.A,{display:"flex",alignItems:"center",gap:1,children:[(0,ee.jsx)(n.A,{variant:"body2",children:"\u6b63\u5728\u540c\u6b65..."}),(0,ee.jsx)(c.A,{sx:{width:100}})]})]})]})}),(0,ee.jsx)(p.A,{children:(0,ee.jsx)(A.A,{onClick:()=>P(!1),children:"\u5173\u95ed"})})]})]})}}}]);
//# sourceMappingURL=502.1a20d343.chunk.js.map